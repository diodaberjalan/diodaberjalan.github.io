<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sidereal Time Calculator</title>
  <style>
    :root {
      --bg: #f0f2f5;
      --card: #ffffff;
      --text: #1a1a1a;
    }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 0 1rem;
      background-color: var(--bg);
      color: var(--text);
    }
    .card {
      background: var(--card);
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 1rem;
    }
    .input-group {
      margin: 1rem 0;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    input,
    select,
    button {
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background: #218bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    button:hover {
      opacity: 0.8;
    }
    .celestial {
      font-size: 1.8rem;
      text-align: center;
      margin: 1rem 0;
      line-height: 1.5;
    }
    .result {
      font-size: 1.5rem;
      text-align: center;
      font-weight: bold;
      margin: 1rem 0;
    }
    .toggle-group {
      display: flex;
      gap: 0.5rem;
      margin: 1rem 0;
    }
    .toggle-group button {
      flex: 1;
    }
    /* Emoji container for celestial positions */
    #emojiContainer {
      position: relative;
      width: 200px;
      height: 200px;
      margin: 1rem auto;
      border: 2px dashed #ddd;
      border-radius: 50%;
    }
    .celestial-emoji {
      position: absolute;
      font-size: 24px;
      width: 24px;
      height: 24px;
      transform: translate(-50%, -50%);
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>🌌 Sidereal Time Calculator</h1>

    <div class="input-group">
      <label>Location:</label>
      <div class="toggle-group">
        <button onclick="detectLocation()">📍 Detect IP</button>
        <button onclick="showManualLocation()">📝 Manual</button>
      </div>
      <select id="citySelect" onchange="updateCity()">
        <option value="">Select City</option>
        <option value="51.5074,-0.1278">London (51.5°N, 0.1°W)</option>
        <option value="40.7128,-74.0060">New York (40.7°N, 74°W)</option>
        <option value="35.6762,139.6503">Tokyo (35.7°N, 139.7°E)</option>
      </select>
      <div id="manualLocation" style="display: none;">
        <input type="number" id="lat" step="0.0001" placeholder="Latitude" />
        <input type="number" id="lon" step="0.0001" placeholder="Longitude" />
      </div>
    </div>

    <div class="input-group">
      <label>Time:</label>
      <div class="toggle-group">
        <button onclick="setCurrentTime()">⏱ Now</button>
        <button onclick="enableCustomTime()">📅 Custom</button>
      </div>
      <input type="datetime-local" id="timeInput" disabled />
    </div>

    <button onclick="calculate()">🚀 Calculate</button>
  </div>

  <div class="card">
    <div class="result" id="result">Sidereal Time:</div>
    <div class="celestial" id="celestialPosition"></div>
    <div id="emojiContainer"></div>
  </div>

  <script>
    // Sidereal time calculation (calculation part remains untouched)
    function calculateSiderealTime(jd, longitude) {
      const T = (jd - 2451545.0) / 36525;
      const gmst = 280.46061837 + 360.98564736629 * (jd - 2451545.0)
                 + 0.000387933 * T * T - T * T * T / 38710000;
      const lst = (gmst / 15 + longitude / 15) % 24;
      return lst < 0 ? lst + 24 : lst;
    }

    function formatHMS(hours) {
      const h = Math.floor(hours);
      const m = Math.floor((hours - h) * 60);
      const s = Math.round(((hours - h) * 60 - m) * 60);
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    // Corrected moon phase calculation
    function getMoonPhaseInfo(jd) {
      const lunarCycle = 29.53058867;
      const newMoonRef = 2451549.5; // Verified reference new moon
      let phase = ((jd - newMoonRef) / lunarCycle) % 1;
      phase = phase < 0 ? phase + 1 : phase;
      
      // Calculate illuminated percentage correctly
      const phaseAngle = phase * 2 * Math.PI;
      const illuminated = (1 - Math.cos(phaseAngle)) / 2;
      const percentage = (illuminated * 100).toFixed(1);

      // Determine moon phase emoji
      let emoji = '🌑';
      if (phase < 0.0625 || phase >= 0.9375) emoji = '🌑';
      else if (phase < 0.1875) emoji = '🌒';
      else if (phase < 0.3125) emoji = '🌓';
      else if (phase < 0.4375) emoji = '🌔';
      else if (phase < 0.5625) emoji = '🌕';
      else if (phase < 0.6875) emoji = '🌖';
      else if (phase < 0.8125) emoji = '🌗';
      else emoji = '🌘';

      return { emoji, percentage, phase };
    }

    // Improved celestial positioning using computed sunAngle and moon phase
    function getCelestialPosition(jd, sunAngle) {
      const moonPhase = getMoonPhaseInfo(jd).phase;
      
      // Moon position relative to sun (180° offset at full moon)
      const moonAngle = (sunAngle + 180 * moonPhase) % 360;
      const sunX = 100 + 100 * Math.cos((sunAngle - 90) * Math.PI / 180);
      const sunY = 100 + 100 * Math.sin((sunAngle - 90) * Math.PI / 180);
      const moonX = 100 + 100 * Math.cos((moonAngle - 90) * Math.PI / 180);
      const moonY = 100 + 100 * Math.sin((moonAngle - 90) * Math.PI / 180);
      return { sunX, sunY, moonX, moonY };
    }

    // Original UI functions remain unchanged
    async function detectLocation() {
      try {
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        document.getElementById('lat').value = data.latitude;
        document.getElementById('lon').value = data.longitude;
        showManualLocation();
      } catch (error) {
        alert('Location detection failed');
      }
    }

    function showManualLocation() {
      document.getElementById('manualLocation').style.display = 'block';
      document.getElementById('citySelect').value = '';
    }

    function updateCity() {
      const [lat, lon] = document.getElementById('citySelect').value.split(',');
      if (lat && lon) {
        document.getElementById('lat').value = lat;
        document.getElementById('lon').value = lon;
        showManualLocation();
      }
    }

    function setCurrentTime() {
      const now = new Date();
      document.getElementById('timeInput').value = now.toISOString().slice(0, 16);
      document.getElementById('timeInput').disabled = true;
    }

    function enableCustomTime() {
      document.getElementById('timeInput').disabled = false;
    }

    // Updated calculation function with emoji visualization for celestial positions
    async function calculate() {
      const lat = parseFloat(document.getElementById('lat').value);
      const lon = parseFloat(document.getElementById('lon').value);
      const inputTime = document.getElementById('timeInput').value;
      const date = new Date(inputTime);
      
      // Convert to Julian Date with UTC correction
      const jd = (Date.UTC(
        date.getFullYear(),
        date.getMonth(),
        date.getDate(),
        date.getHours(),
        date.getMinutes(),
        date.getSeconds()
      ) / 86400000) + 2440587.5;

      const lstHours = calculateSiderealTime(jd, lon);
      document.getElementById('result').textContent =
        `Local Sidereal Time: ${formatHMS(lstHours)}`;

      // Get accurate moon phase info
      const moonInfo = getMoonPhaseInfo(jd);
      
      // Calculate celestial positions based on UTC hours
      const hours = date.getUTCHours() + date.getUTCMinutes() / 60;
      const sunAngle = (hours / 24) * 360; // 0° at midnight, 180° at noon, etc.
      const positions = getCelestialPosition(jd, sunAngle);

      // Build emoji visualization for sun and moon positions
      const emojiContainer = document.getElementById('emojiContainer');
      // Clear previous contents
      emojiContainer.innerHTML = '';

      // Create sun emoji element
      const sunEmoji = document.createElement('div');
      sunEmoji.className = 'celestial-emoji';
      sunEmoji.textContent = '🌞';
      sunEmoji.style.left = positions.sunX + 'px';
      sunEmoji.style.top = positions.sunY + 'px';
      emojiContainer.appendChild(sunEmoji);

      // Create moon emoji element
      const moonEmoji = document.createElement('div');
      moonEmoji.className = 'celestial-emoji';
      moonEmoji.textContent = '🌜';
      moonEmoji.style.left = positions.moonX + 'px';
      moonEmoji.style.top = positions.moonY + 'px';
      emojiContainer.appendChild(moonEmoji);

      // Display moon phase info and percentage
      document.getElementById('celestialPosition').innerHTML = `
        <div>Moon Phase: ${moonInfo.emoji} (${moonInfo.percentage}% illuminated)</div>
      `;
    }

    // Initial setup
    setCurrentTime();
  </script>
</body>
</html>
