<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sidereal Time Calculator</title>
  <style>
    :root {
      --bg: #eef2f7;
      --card: #ffffff;
      --text: #333;
      --primary: #218bff;
      --accent: #ffd700;
      --border: #ccc;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1rem;
      display: flex;
      justify-content: center;
    }
    .container {
      max-width: 600px;
      width: 100%;
    }
    .card {
      background: var(--card);
      padding: 1.5rem 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    .input-group {
      margin: 1rem 0;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    input,
    select,
    button {
      padding: 0.6rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
      font-size: 1rem;
    }
    button {
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      transition: opacity 0.2s ease;
      margin-top: 0.5rem;
    }
    button:hover {
      opacity: 0.9;
    }
    .toggle-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .toggle-group button {
      flex: 1;
      padding: 0.5rem;
      font-size: 0.9rem;
    }
    .result {
      font-size: 1.4rem;
      text-align: center;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .celestial {
      font-size: 1.2rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    /* Emoji container for celestial positions */
    #emojiContainer {
      position: relative;
      width: 220px;
      height: 220px;
      margin: 0 auto 1rem auto;
      border: 2px dashed var(--border);
      border-radius: 50%;
      background-color: #fafafa;
    }
    .celestial-emoji {
      position: absolute;
      font-size: 32px;
      width: 32px;
      height: 32px;
      transform: translate(-50%, -50%);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>🌌 Sidereal Time Calculator</h1>

      <div class="input-group">
        <label>Location:</label>
        <div class="toggle-group">
          <button onclick="detectLocation(); calculate();">📍 Detect IP</button>
          <button onclick="showManualLocation()">📝 Manual</button>
        </div>
        <select id="citySelect" onchange="updateCity()">
          <option value="">Select City</option>
          <option value="13.7563,100.5018">Bangkok (13.8°N, 100.5°E)</option>
          <option value="39.9042,116.4074">Beijing (39.9°N, 116.4°E)</option>
          <option value="-34.6037,-58.3816">Buenos Aires (34.6°S, 58.4°W)</option>
          <option value="30.0444,31.2357">Cairo (30.0°N, 31.2°E)</option>
          <option value="28.7041,77.1025">Delhi (28.7°N, 77.1°E)</option>
          <option value="23.8103,90.4125">Dhaka (23.8°N, 90.4°E)</option>
          <option value="41.0082,28.9784">Istanbul (41.0°N, 29.0°E)</option>
          <option value="-6.2088,106.8456">Jakarta (6.2°S, 106.8°E)</option>
          <option value="24.8607,67.0011">Karachi (24.9°N, 67.0°E)</option>
          <option value="22.5726,88.3639">Kolkata (22.6°N, 88.4°E)</option>
          <option value="51.5074,-0.1278">London (51.5°N, 0.1°W)</option>
          <option value="34.0522,-118.2437">Los Angeles (34.1°N, 118.2°W)</option>
          <option value="19.4326,-99.1332">Mexico City (19.4°N, 99.1°W)</option>
          <option value="55.7558,37.6173">Moscow (55.8°N, 37.6°E)</option>
          <option value="19.0760,72.8777">Mumbai (19.1°N, 72.9°E)</option>
          <option value="40.7128,-74.0060">New York (40.7°N, 74.0°W)</option>
          <option value="-22.9068,-43.1729">Rio de Janeiro (22.9°S, 43.2°W)</option>
          <option value="-23.5505,-46.6333">São Paulo (23.6°S, 46.6°W)</option>
          <option value="37.5665,126.9780">Seoul (37.6°N, 127.0°E)</option>
          <option value="35.6895,139.6917">Tokyo (35.7°N, 139.7°E)</option>
        </select>
        <div id="manualLocation" style="display: none; margin-top: 0.5rem;">
          <input type="number" id="lat" step="0.0001" placeholder="Latitude" />
          <input type="number" id="lon" step="0.0001" placeholder="Longitude" style="margin-top: 0.5rem;" />
        </div>
      </div>

      <div class="input-group">
        <label>Time (UTC): </label>
        <div class="toggle-group">
          <button onclick="setCurrentTime(); calculate();">⏱ Now</button>
          <button onclick="enableCustomTime()">📅 Custom</button>
        </div>
        <input type="datetime-local" id="timeInput" disabled />
      </div>

      <button onclick="calculate()">🚀 Calculate</button>
    </div>

    <div class="card">
      <div class="result" id="result">Sidereal Time:</div>
      <div class="celestial" id="celestialPosition"></div>
      <div id="emojiContainer"></div>
    </div>
  </div>

  <script>
    // Sidereal time calculation (calculation part remains untouched)
    function calculateSiderealTime(jd, longitude) {
      const T = (jd - 2451545.0) / 36525;
      const gmst = 280.46061837 + 360.98564736629 * (jd - 2451545.0)
                 + 0.000387933 * T * T - T * T * T / 38710000;
      const lst = (gmst / 15 + longitude / 15) % 24;
      return lst < 0 ? lst + 24 : lst;
    }

    function formatHMS(hours) {
      const h = Math.floor(hours);
      const m = Math.floor((hours - h) * 60);
      const s = Math.round(((hours - h) * 60 - m) * 60);
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    // Corrected moon phase calculation
    function getMoonPhaseInfo(jd) {
      const lunarCycle = 29.53058867;
      const newMoonRef = 2451549.5; // Verified reference new moon
      let phase = ((jd - newMoonRef) / lunarCycle) % 1;
      phase = phase < 0 ? phase + 1 : phase;
      
      // Calculate illuminated percentage correctly
      const phaseAngle = phase * 2 * Math.PI;
      const illuminated = (1 - Math.cos(phaseAngle)) / 2;
      const percentage = (illuminated * 100).toFixed(1);

      // Determine moon phase emoji
      let emoji = '🌑';
      if (phase < 0.0625 || phase >= 0.9375) emoji = '🌑';
      else if (phase < 0.1875) emoji = '🌒';
      else if (phase < 0.3125) emoji = '🌓';
      else if (phase < 0.4375) emoji = '🌔';
      else if (phase < 0.5625) emoji = '🌕';
      else if (phase < 0.6875) emoji = '🌖';
      else if (phase < 0.8125) emoji = '🌗';
      else emoji = '🌘';

      return { emoji, percentage, phase };
    }

    // Improved celestial positioning using computed sunAngle and moon phase
    function getCelestialPosition(jd, sunAngle) {
      const moonPhase = getMoonPhaseInfo(jd).phase;
      
      // Moon position relative to sun (180° offset at full moon)
      const moonAngle = (sunAngle + 180 * moonPhase) % 360;
      const sunX = 100 + 100 * Math.cos((sunAngle - 90) * Math.PI / 180);
      const sunY = 100 + 100 * Math.sin((sunAngle - 90) * Math.PI / 180);
      const moonX = 100 + 100 * Math.cos((moonAngle - 90) * Math.PI / 180);
      const moonY = 100 + 100 * Math.sin((moonAngle - 90) * Math.PI / 180);
      return { sunX, sunY, moonX, moonY };
    }

    // Original UI functions remain unchanged
    async function detectLocation() {
      try {
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        document.getElementById('lat').value = data.latitude;
        document.getElementById('lon').value = data.longitude;
        showManualLocation();
      } catch (error) {
        alert('Location detection failed');
      }
    }

    function showManualLocation() {
      document.getElementById('manualLocation').style.display = 'block';
      document.getElementById('citySelect').value = '';
    }

    function updateCity() {
      const [lat, lon] = document.getElementById('citySelect').value.split(',');
      if (lat && lon) {
        document.getElementById('lat').value = lat;
        document.getElementById('lon').value = lon;
        showManualLocation();
      }
    }

    function setCurrentTime() {
      const now = new Date();
      document.getElementById('timeInput').value = now.toISOString().slice(0, 16);
      document.getElementById('timeInput').disabled = true;
    }

    function enableCustomTime() {
      document.getElementById('timeInput').disabled = false;
    }

    // Updated calculation function with emoji visualization for celestial positions
    async function calculate() {
      const lat = parseFloat(document.getElementById('lat').value);
      const lon = parseFloat(document.getElementById('lon').value);
      const inputTime = document.getElementById('timeInput').value;
      const date = new Date(inputTime);
      
      // Convert to Julian Date with UTC correction
      const jd = (Date.UTC(
        date.getFullYear(),
        date.getMonth(),
        date.getDate(),
        date.getHours(),
        date.getMinutes(),
        date.getSeconds()
      ) / 86400000) + 2440587.5;

      const lstHours = calculateSiderealTime(jd, lon);
      document.getElementById('result').textContent =
        `Local Sidereal Time: ${formatHMS(lstHours)}`;

      // Get accurate moon phase info
      const moonInfo = getMoonPhaseInfo(jd);
      
      // Calculate celestial positions based on UTC hours
      const hours = date.getUTCHours() + date.getUTCMinutes() / 60;
      const sunAngle = (hours / 24) * 360; // 0° at midnight, 180° at noon, etc.
      const positions = getCelestialPosition(jd, sunAngle);

      // Build emoji visualization for sun and moon positions
      const emojiContainer = document.getElementById('emojiContainer');
      // Clear previous contents
      emojiContainer.innerHTML = '';

      // Create sun emoji element
      const sunEmoji = document.createElement('div');
      sunEmoji.className = 'celestial-emoji';
      sunEmoji.textContent = '🌞';
      sunEmoji.style.left = positions.sunX + 'px';
      sunEmoji.style.top = positions.sunY + 'px';
      emojiContainer.appendChild(sunEmoji);

      // Create moon emoji element
      const moonEmoji = document.createElement('div');
      moonEmoji.className = 'celestial-emoji';
      moonEmoji.textContent = '🌜';
      moonEmoji.style.left = positions.moonX + 'px';
      moonEmoji.style.top = positions.moonY + 'px';
      emojiContainer.appendChild(moonEmoji);

      // Display moon phase info and percentage
      document.getElementById('celestialPosition').innerHTML = `
        <div>Moon Phase: ${moonInfo.emoji} (${moonInfo.percentage}% illuminated)</div>
      `;
    }

    // Initial setup: automatically use current time and location, then calculate LST.
    window.onload = async function() {
      setCurrentTime();
      await detectLocation();
      calculate();
    };
  </script>
</body>
</html>
